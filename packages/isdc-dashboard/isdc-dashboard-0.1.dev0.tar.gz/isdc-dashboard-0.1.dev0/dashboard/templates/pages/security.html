{% load i18n %}
{% load humanize %}

<style type="text/css">
li#nav_dashsecurity>a::after {
    content: '';
    position: absolute;
    left: 0;
    display: inline-block;
    height: 0.4em;
    width: 100%;
    border-bottom: 2px solid #755467;
    margin-top: 5px;
}
</style>

<div class="gridster">
	<h1 class="dashing-title">{% trans "Humanitarian Access" %}
		{% include "links_title.html" %}
		{% include "qlink_span.html" %}
	</h1>

</div>

<div class="gridster" style="margin-bottom: 39px;">
	<div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;">
	    <i class="fa fa-calendar"></i>&nbsp; {% trans "Incident between" %}:
	    <span></span> <b class="caret"></b>
	</div>
</div>

<!-- <div class="gridster" style="margin-bottom: 69px; z-index:3001;opacity:1 !important;">
	<div class="pull-left" style="padding-left: 10px;">
		<select class="selectpicker" multiple data-selected-text-format="count" data-actions-box="true" data-selectAllText="All Selected">
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		</select>
	</div>
	<div class="pull-right">
		<select class="selectpicker" multiple data-actions-box="true">
		  <option>Mustard</option>
		  <option>Ketchup</option>
		  <option>Relish</option>
		</select>
	</div>
</div> -->

<div class="gridster">
  	<ul>
  		<li data-row="1" data-col="1" data-sizex="3" data-sizey="2" style="padding:5px;">
  			<!-- <select multiple="multiple" id="incidentType-select" name="my-select[]">
		      {% for item in main_type_child %}
		      	<option value='{{ item.main_type }}' {% if item.main_type in incident_type %}selected{% endif %}>{{ item.main_type }} ({{item.count}} incidents)</option>
		      {% endfor %}
		    </select> -->
		    <div class="custom-header">
		    	<div style="float:left;font-size: small;padding: 5px;">{% trans "select incident type" %}</div>
		    	<div style="float:right;">
		    		<button type="button" class="btn btn-primary btn-sm type_all">{% trans "Select All" %}</button>
		    		<button type="button" class="btn btn-primary btn-sm type_none">{% trans "Select None" %}</button>
		    		<button type="button" class="btn btn-primary btn-sm apply">{% trans "Apply" %}</button>
		    	</div>
		    </div>
        {% get_current_language_bidi as LANGUAGE_BIDI %}
	    	{% for item in main_type_child %}
	                <div class="checkbox {{ LANGUAGE_BIDI | yesno:'rtl, ltr' }} checkbox-inline">
	                    <input id="type{{ forloop.counter0 }}" name="main_type_select[]" class="styled" type="checkbox" value="{{ item.main_type }}"  {% if item.main_type in incident_type %}checked=true{% endif %}>
	                    <label for="type{{ forloop.counter0 }}">
	                        {{ item.main_type }} ({{item.count}} incidents)
	                    </label>
	                </div>
            {% endfor %}

		</li>
  		<!-- <li data-row="1" data-col="1" data-sizex="2" data-sizey="2">
			<div>{{ casualties_chart.as_html }}</div>
			<span class='widget-title'></span>
		</li> -->
		<li data-row="1" data-col="1" data-sizex="3" data-sizey="2" style="padding:5px;">
			<!-- <select multiple="multiple" id="incidentTarget-select" name="my-select[]">
		      {% for item in main_target_child %}
		      	<option value='{{ item.main_target }}' {% if item.main_target in incident_target %}selected{% endif %}>{{ item.main_target }} ({{item.count}} incidents)</option>
		      {% endfor %}
		    </select> -->
		    <div class="custom-header">
		    	<div style="float:left;font-size: small;padding: 5px;">{% trans "select incident target" %}</div>
		    	<div style="float:right;">
		    		<button type="button" class="btn btn-primary btn-sm target_all">{% trans "Select All" %}</button>
		    		<button type="button" class="btn btn-primary btn-sm target_none">{% trans "Select None" %}</button>
		    		<button type="button" class="btn btn-primary btn-sm apply">{% trans "Apply" %}</button>
		    	</div>
		    </div>
	    	{% for item in main_target_child %}
	                <div class="checkbox {{ LANGUAGE_BIDI | yesno:'rtl, ltr' }} checkbox-inline">
	                    <input id="target{{ forloop.counter0 }}" name="main_target_select[]" class="styled" type="checkbox" value="{{ item.main_target }}"  {% if item.main_target in incident_target %}checked=true{% endif %}>
	                    <label for="target{{ forloop.counter0 }}">
	                        {{ item.main_target }} ({{item.count}} incidents)
	                    </label>
	                </div>
            {% endfor %}
		</li>

  	</ul>
</div>

<div class="gridster">
  	<ul>
  		<li data-row="1" data-col="1" data-sizex="3" data-sizey="3">
			<div><img style="width:450px;height:450px;" src="{{ main_type_chart }}" /></div>
			<span class='widget-title'></span>
		</li>
		<li data-row="1" data-col="2" data-sizex="3" data-sizey="3">
			<div><img style="width:450px;height:450px;" src="{{ main_target_chart }}" /></div>
			<span class='widget-title'></span>
		</li>
  	</ul>
</div>

<div class="page-break"></div>


<div class="gridster">
  	<ul>
  		<li data-row="1" data-col="1" data-sizex="3" data-sizey="3">
			<div><img style="width:450px;height:450px;" src="{{ dead_casualties_type_chart }}" /></div>
			<span class='widget-title'></span>
		</li>
		<li data-row="1" data-col="2" data-sizex="3" data-sizey="3">
			<div><img style="width:450px;height:450px;" src="{{ dead_casualties_target_chart }}" /></div>
			<span class='widget-title'></span>
		</li>

		<li data-row="2" data-col="1" data-sizex="3" data-sizey="3">
			<div><img style="width:450px;height:450px;" src="{{ injured_casualties_type_chart }}" /></div>
			<span class='widget-title'></span>
		</li>
		<li data-row="2" data-col="2" data-sizex="3" data-sizey="3">
			<div><img style="width:450px;height:450px;" src="{{ injured_casualties_target_chart }}" /></div>
			<span class='widget-title'></span>
		</li>
  	</ul>
</div>

<div class="page-break"></div>

<div class="gridster">
  	<ul>

		<li data-row="1" data-col="1" data-sizex="3" data-sizey="3">
			<div><img style="width:450px;height:450px;" src="{{ violent_casualties_type_chart }}" /></div>
			<span class='widget-title'></span>
		</li>
		<li data-row="1" data-col="2" data-sizex="3" data-sizey="3">
			<div><img style="width:450px;height:450px;" src="{{ violent_casualties_target_chart }}" /></div>
			<span class='widget-title'></span>
		</li>


  	</ul>
</div>


<div  class="gridster">
	<table>
		<thead>
			<tr class='dataitem'>
				<td colspan=3 style="padding:3px;font-weight:bolder;">{% trans "Number of incidents and casualties" %}</td>
				<td colspan=2 style="padding:3px;"><div class='showFlag_base' onClick='show_hide_base()'>{% if "detail_base" in checked %}{% trans "Hide Detail" %}{% else %}{% trans "Show Detail" %}{% endif %}</div></td>
			</tr>
			<tr>
				<th rowspan=2><span>{% trans "Region" %}</span></th>
				<th rowspan=2><span>{% trans "# Incidents" %}</span></th>
				<th colspan=3>{% trans "Casualties" %}</th>
				<!-- <th rowspan=2><span>Health Facilities</span></th>
				<th rowspan=2><span>Length of Roads</span></th> -->
			</tr>
			<tr>
				<th><span>{% trans "Dead" %}</span></th>
				<th><span>{% trans "Injured" %}</span></th>
				<th><span>{% trans "Violent" %}</span></th>
			</tr>
		</thead>
		<tbody>
			<tr class='dataitem'>
				<td class="parent_list">{{parent_label}}</td>
				<td class="parent_value">{{total_incident | intword | intcomma}}</td>
				<td class="parent_value">{{total_dead | intword | intcomma}}</td>
				<td class="parent_value">{{total_injured | intword | intcomma}}</td>
				<td class="parent_value">{{total_violent | intword | intcomma}}</td>
			</tr>
			{% for data in lc_child %}
			<tr class='dataitem detail_base {% if "detail_base" not in checked %} hide {% endif %}' onclick="jump_url({{data.code}});">
				<td class="detail_list">{{data.na_en}}</td>
				<td class="detail_value">{{data.total_incident | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_dead | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_injured | intword | intcomma}}</td>
				<td class="detail_value">{{data.total_violent | intword | intcomma}}</td>
			</tr>
			{% endfor %}
			<tr>
				<td class="separator" colspan=10></td>
			</tr>
		</tbody>
	</table>
</div>

<div class="gridster">
	<div class="col-md-6 col-cust-4" style="padding-left:0px !important;">
		<div class="table_scroll">
			<table id="incident-type" style="font-size: small !important;margin-top:0 !important;">
				<thead>
					<tr>
						<th colspan=5 style="padding:3px;font-weight:bolder;">{% trans "Incident Type" %}</th>
					</tr>
					<tr>
						<th></th>
						<th>{% trans "Incidents" %}</th>
						<th>{% trans "Dead" %}</th>
						<th>{% trans "Injured" %}</th>
						<th>{% trans "Violent" %}</th>
					</tr>
				</thead>
				<tbody>
					{% for data in incident_type_group %}
						<tr style="background: #eee;">
							<td style="">{{ data.main_type }}</td>
							<td style="">{{ data.count }}</td>
							<td style="">{{ data.dead }}</td>
							<td style="">{{ data.injured }}</td>
							<td style="">{{ data.violent }}</td>
						</tr>
						{% for item in data.child %}
							<tr>
								<td style="word-wrap: break-word;max-width:100px;">{{ item.type }}</td>
								<td style="">{{ item.count }}</td>
								<td style="">{{ item.dead }}</td>
								<td style="">{{ item.injured }}</td>
								<td style="">{{ item.violent }}</td>
							</tr>
						{% endfor %}
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	<div class="col-md-6 col-cust-4"  style="padding-right:0px !important;">
		<div class="table_scroll">
			<table id="incident-target" style="font-size: small !important;margin-top:0 !important;">
				<thead>
					<tr>
						<th colspan=5 style="padding:3px;font-weight:bolder;">{% trans "Incident Target" %}</th>
					</tr>
					<tr>
						<th></th>
						<th>{% trans "Incidents" %}</th>
						<th>{% trans "Dead" %}</th>
						<th>{% trans "Injured" %}</th>
						<th>{% trans "Violent" %}</th>
					</tr>
				</thead>
				<tbody>
					{% for data in incident_target_group %}
						<tr style="background: #eee;">
							<td style="">{{ data.main_target }}</td>
							<td style="">{{ data.count }}</td>
							<td style="">{{ data.dead }}</td>
							<td style="">{{ data.injured }}</td>
							<td style="">{{ data.violent }}</td>
						</tr>
						{% for item in data.child %}
							<tr>
								<td style="word-wrap: break-word;max-width:100px;">{{ item.target }}</td>
								<td style="">{{ item.count }}</td>
								<td style="">{{ item.dead }}</td>
								<td style="">{{ item.injured }}</td>
								<td style="">{{ item.violent }}</td>
							</tr>
						{% endfor %}
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	<div class="col-md-12" style="padding-right:0px !important;padding-left:0px !important;">
		<div class="table_scroll">
			<table id="latest-incidents" style="font-size: small !important;margin-top:0 !important;">
				<thead>
					<tr>
						<th colspan=2 style="padding:3px;font-weight:bolder;">{% trans "Latest Incidents" %}</th>
					</tr>
					<tr>
						<th>{% trans "Date" %}</th>
						<th>{% trans "Description" %}</th>
					</tr>
				</thead>
				<tbody>
				{% for item in incident_list_100 %}
					<tr>
						<td style="width: 100px;">{{ item.incident_date }}</td>
						<td style="">{{ item.description }}</td>
					</tr>
				{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>




<SCRIPT TYPE="text/javascript">

function show_hide_base(){
	if ($("div.showFlag_base").text() == "{% trans "Show Detail" %}") {
		$("div.showFlag_base").text('{% trans "Hide Detail" %}');
		_checked.push('detail_base');
	} else {
		$("div.showFlag_base").text('{% trans "Show Detail" %}');
		removeA(_checked, 'detail_base');
	}
	$( ".detail_base" ).toggleClass(function(){
		if ( $( this ).parent().is( ".hide" ) ) {
		    return "show";
		} else {
			// $("div.showFlag").text("<p>Show Detail</p>");
		    return "hide";
		}
	});
}

document.addEventListener('DOMContentLoaded', function() {
	var daterange = getParameterByName("daterange");
    if (daterange == null){
      var start = moment().subtract(365, 'days');
      var end = moment();
    } else {
      var dateVar = daterange.split(',');
      var start = moment(new Date(dateVar[0].substr(0, 4), parseInt(dateVar[0].substr(5, 2))-1, dateVar[0].substr(8, 2)));
      var end = moment(new Date(dateVar[1].substr(0, 4), parseInt(dateVar[1].substr(5, 2))-1, dateVar[1].substr(8, 2)));;
    }



    function cb(start, end) {
        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
           '{% trans 'Today' %}': [moment(), moment()],
           '{% trans 'Yesterday' %}': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           '{% trans 'Last 7 Days' %}': [moment().subtract(6, 'days'), moment()],
           '{% trans 'Last 30 Days' %}': [moment().subtract(29, 'days'), moment()],
           '{% trans 'This Month' %}': [moment().startOf('month'), moment().endOf('month')],
           '{% trans 'Last Month' %}': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
           '{% trans 'Last Year' %}': [moment().subtract(365, 'days'), moment()]
        }
    }, cb);

    cb(start, end);

    $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
        var url = $(location).attr("href");
        if (daterange == null){
          window.document.location = url+'&daterange='+picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD');
        }  else {
          // url = url.replace(/(daterange=).*?(&)/,'$1' + picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD') + '$2');
          url = updateUrlParameter(url, 'daterange', picker.startDate.format('YYYY-MM-DD')+','+picker.endDate.format('YYYY-MM-DD'))

          window.document.location = url;
        }
    });

    $('#incidentType-select').multiSelect({
      selectableHeader: "<div class='custom-header'>{% trans "Unselected Incident Type" %} <button type='button' class='apply btn btn-primary btn-sm'>Apply</button></div>",
      selectionHeader: "<div class='custom-header'>{% trans "Selected Incident Type" %} <button type='button' class='apply btn btn-primary btn-sm'>Apply</button></div>"
    });

    $('#incidentTarget-select').multiSelect({
      selectableHeader: "<div class='custom-header'>{% trans "Unselected Incident Target" %} <button type='button' class='btn btn-primary btn-sm apply'>Apply</button></div>",
      selectionHeader: "<div class='custom-header'>{% trans "Selected Incident Target" %} <button type='button' class='btn btn-primary btn-sm apply'>Apply</button></div>"
    });


	$('button.apply').on('click', function(event) {
		var type_selected_param = '';
		var target_selected_param = '';

		// var type_unselected = $('#ms-incidentType-select').find('.ms-elem-selectable:not(.ms-selected)');
		// var type_selected = $('#ms-incidentType-select').find('.ms-elem-selectable.ms-selected');

		var type_unselected = $("input[name='main_type_select[]']:checkbox:not(:checked)");
		var type_selected = $("input[name='main_type_select[]']:checkbox:checked");

		// var target_unselected = $('#ms-incidentTarget-select').find('.ms-elem-selectable:not(.ms-selected)');
		// var target_selected = $('#ms-incidentTarget-select').find('.ms-elem-selectable.ms-selected');

		var target_unselected = $("input[name='main_target_select[]']:checkbox:not(:checked)");
		var target_selected = $("input[name='main_target_select[]']:checkbox:checked");

		if (type_unselected.length > 0) {
			// var type_array = type_selected.val();
			var type_array = [];
			type_selected.each( function () {
			   type_array.push($(this).val());
			});
			type_selected_param += type_array;
		}


		if (target_unselected.length > 0) {
			// var target_array = $('#incidentTarget-select').val();
			var target_array = [];
			target_selected.each( function () {
			   target_array.push($(this).val());
			});
			target_selected_param += target_array
		}

		if (type_selected.length == 0) {
			type_selected_param = 'noselection';
		}

		if (target_selected.length == 0) {
			target_selected_param = 'noselection';
		}

		var url = $(location).attr("href");

		if (type_selected_param != ''){
			if (getParameterByName("incident_type") == null){
				url += '&incident_type='+type_selected_param;
			} else {
				url = updateUrlParameter(url, 'incident_type', type_selected_param);
			}

		} else {
			url = removeParam('incident_type', url);
		}

		if (target_selected_param != ''){
			if (getParameterByName("incident_target") == null){
				url += '&incident_target='+target_selected_param;
			} else {
				url = updateUrlParameter(url, 'incident_target', target_selected_param)
			}

		} else {
			url = removeParam('incident_target', url);
		}

		window.document.location = url;

	});

	$('button.type_all').on('click', function(event) {
		$("input[name='main_type_select[]']:checkbox").prop('checked', true);
	});

	$('button.type_none').on('click', function(event) {
		$("input[name='main_type_select[]']:checkbox").prop('checked', false);
	});

	$('button.target_all').on('click', function(event) {
		$("input[name='main_target_select[]']:checkbox").prop('checked', true);
	});

	$('button.target_none').on('click', function(event) {
		$("input[name='main_target_select[]']:checkbox").prop('checked', false);
	});
});

</SCRIPT>
